# Authentication Guide

Complete guide to OAuth 2.0 authentication for the Google Workspace MCP server.

**Last Updated:** 2026-01-05

---

## Overview

The Google Workspace MCP server uses **OAuth 2.0** to securely access your Google account. This guide explains how authentication works and how to manage credentials.

### Authentication Flow

```
1. You run: npm run setup-auth
2. Browser opens â†’ Google login
3. You authorize the MCP server
4. Google returns authorization code
5. Server exchanges code for tokens
6. Tokens saved to token.json
7. Server uses tokens for API requests
8. Tokens automatically refresh when expired
```

---

## Prerequisites

Before authenticating, ensure you have:
- [ ] Created a Google Cloud project
- [ ] Enabled all 6 required APIs
- [ ] Created OAuth 2.0 credentials
- [ ] Downloaded `credentials.json` to project root

**If not done:** See [Installation Guide](installation.md#phase-1-google-cloud-setup)

---

## Initial Authentication

### Step 1: Run Authentication Script

```bash
npm run setup-auth
```

### Step 2: Authorize in Browser

The script will:
1. Open your default browser
2. Navigate to Google's OAuth consent page
3. Show the app name: "Google Workspace MCP Server"
4. Display requested permissions

**Permissions Requested:**
- **Gmail:** `https://www.googleapis.com/auth/gmail.modify`
  - Send, read, and manage emails
- **Drive:** `https://www.googleapis.com/auth/drive`
  - Full access to files and folders
- **Sheets:** `https://www.googleapis.com/auth/spreadsheets`
  - Create and edit spreadsheets
- **Docs:** `https://www.googleapis.com/auth/documents`
  - Create and edit documents
- **Calendar:** `https://www.googleapis.com/auth/calendar`
  - Manage calendar events
- **Tasks:** `https://www.googleapis.com/auth/tasks`
  - Manage task lists

### Step 3: Grant Permissions

1. Select your Google account
2. Review the permissions
3. Click **"Allow"** or **"Continue"**
4. Copy the authorization code shown

### Step 4: Complete Authentication

1. Return to your terminal
2. Paste the authorization code
3. Press Enter

**Expected output:**
```
âœ“ Token saved to token.json
âœ“ Authentication complete!
âœ“ Setup complete! You can now use the MCP server.
```

---

## Understanding Tokens

### Token Files

Two files are used for authentication:

#### credentials.json

- **What:** OAuth 2.0 client credentials
- **Contains:** Client ID, client secret, redirect URIs
- **Source:** Downloaded from Google Cloud Console
- **Security:** Keep private, never commit to git
- **Regenerate:** If compromised, create new credentials in Google Cloud

#### token.json

- **What:** Access and refresh tokens
- **Contains:** Access token, refresh token, expiry time
- **Source:** Generated by authentication script
- **Security:** Keep private, never commit to git
- **Regenerate:** Delete file and run `npm run setup-auth` again

### Token Lifecycle

```
Access Token:
â”œâ”€â”€ Expires: After 1 hour
â”œâ”€â”€ Used for: API requests
â””â”€â”€ Automatically refreshed using refresh token

Refresh Token:
â”œâ”€â”€ Expires: Never (unless revoked)
â”œâ”€â”€ Used for: Getting new access tokens
â””â”€â”€ Stored securely in token.json
```

---

## Token Management

### Refresh Tokens

Tokens are automatically refreshed by the Google APIs client library:

```typescript
// Automatic refresh - handled by the library
const auth = new google.auth.OAuth2(/* ... */);
auth.setCredentials(tokens);
// If access token is expired, library automatically uses refresh token
```

You don't need to manually refresh tokens!

### Revoke Access

To revoke access to your Google account:

**Option 1: Through Google**
1. Go to https://myaccount.google.com/permissions
2. Find "Google Workspace MCP Server"
3. Click "Remove Access"

**Option 2: Delete Local Tokens**
```bash
rm token.json
rm credentials.json  # Optional
```

Then re-authenticate to restore access.

### Rotate Tokens

For security, periodically rotate your tokens:

```bash
# Delete existing tokens
rm token.json

# Re-authenticate
npm run setup-auth
```

**Recommended:** Rotate every 90 days or when:
- You suspect token compromise
- Team member leaves who had access
- Moving from development to production
- Regular security maintenance

---

## Custom Credential Paths

By default, credentials are stored in the project root. For custom paths:

### Using Environment Variables

1. **Create .env file:**
   ```bash
   cp .env.example .env
   ```

2. **Set custom paths:**
   ```bash
   CREDENTIALS_PATH=/path/to/your/credentials.json
   TOKEN_PATH=/path/to/your/token.json
   ```

3. **Authenticate:**
   ```bash
   npm run setup-auth
   ```

The script will use your custom paths.

### Claude Desktop Configuration

If using custom paths, update your Claude Desktop config:

```json
{
  "mcpServers": {
    "google-workspace": {
      "command": "node",
      "args": ["/path/to/dist/index.js"],
      "env": {
        "CREDENTIALS_PATH": "/path/to/credentials.json",
        "TOKEN_PATH": "/path/to/token.json"
      }
    }
  }
}
```

---

## Multiple Google Accounts

To use multiple Google accounts with separate MCP server instances:

### Approach 1: Separate Projects

1. **Create separate project directories:**
   ```bash
   mkdir google-workspace-mcp-personal
   mkdir google-workspace-mcp-work
   ```

2. **Set up each project:**
   ```bash
   cd google-workspace-mcp-personal
   npm install
   npm run build
   npm run setup-auth  # Authenticate with personal account

   cd ../google-workspace-mcp-work
   npm install
   npm run build
   npm run setup-auth  # Authenticate with work account
   ```

3. **Configure Claude Desktop:**
   ```json
   {
     "mcpServers": {
       "google-workspace-personal": {
         "command": "node",
         "args": ["/path/to/google-workspace-mcp-personal/dist/index.js"]
       },
       "google-workspace-work": {
         "command": "node",
         "args": ["/path/to/google-workspace-mcp-work/dist/index.js"]
       }
     }
   }
   ```

### Approach 2: Environment Variables

1. **Create separate .env files:**
   ```bash
   # .env.personal
   CREDENTIALS_PATH=/path/to/personal-credentials.json
   TOKEN_PATH=/path/to/personal-token.json

   # .env.work
   CREDENTIALS_PATH=/path/to/work-credentials.json
   TOKEN_PATH=/path/to/work-token.json
   ```

2. **Authenticate each account:**
   ```bash
   # Personal account
   cp .env.personal .env
   npm run setup-auth
   mv token.json personal-token.json

   # Work account
   cp .env.work .env
   npm run setup-auth
   mv token.json work-token.json
   ```

---

## Troubleshooting

### "Invalid credentials" Error

**Problem:** `credentials.json` is missing or invalid

**Solutions:**
1. Verify file exists:
   ```bash
   ls -la credentials.json
   ```

2. Verify file is valid JSON:
   ```bash
   cat credentials.json | python -m json.tool
   ```

3. Re-download from Google Cloud Console:
   - Go to APIs & Services â†’ Credentials
   - Find your OAuth client ID
   - Click download icon
   - Save as `credentials.json`

### "Token has been expired or revoked" Error

**Problem:** Access token is invalid

**Solution:**
```bash
rm token.json
npm run setup-auth
```

### "Access not configured" Error

**Problem:** Required API not enabled in Google Cloud

**Solution:**
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Navigate to APIs & Services â†’ Library
3. Enable all six required APIs
4. Wait 1-2 minutes for propagation
5. Try authentication again

### "Redirect URI mismatch" Error

**Problem:** OAuth client type is incorrect

**Solution:**
1. Go to Google Cloud Console â†’ APIs & Services â†’ Credentials
2. Delete existing OAuth client
3. Create new OAuth client with type: **Desktop app**
4. Download new `credentials.json`
5. Run `npm run setup-auth` again

### Browser Doesn't Open

**Problem:** System can't open default browser

**Manual solution:**
1. Copy the URL from terminal output
2. Open URL in any browser
3. Complete OAuth flow
4. Copy authorization code
5. Paste into terminal

### "insufficient_scope" Error

**Problem:** Token doesn't have required permissions

**Solution:**
```bash
rm token.json
npm run setup-auth
# Ensure you click "Allow" for ALL permissions
```

---

## Security Best Practices

### Protect Credentials

1. **Never commit to git:**
   ```bash
   # Verify .gitignore includes:
   credentials.json
   token.json
   .env
   ```

2. **Use restrictive file permissions:**
   ```bash
   chmod 600 credentials.json
   chmod 600 token.json
   ```

3. **Store securely:**
   - Use encrypted storage if possible
   - Keep backups in secure location
   - Don't share via email/messaging

### Limit Access

1. **Use test users:**
   - Add only necessary email addresses to OAuth consent screen
   - Remove users when no longer needed

2. **Scope limitation:**
   - Only enable APIs you actually use
   - Review scopes periodically

3. **Monitor usage:**
   - Check Google Cloud Console for API usage
   - Set up alerts for unusual activity
   - Review OAuth permissions: https://myaccount.google.com/permissions

### Production Considerations

For production deployments:

1. **Use service accounts** (if applicable)
2. **Implement token encryption** at rest
3. **Rotate credentials** on a schedule
4. **Monitor for anomalies**
5. **Have token revocation procedure**
6. **Use separate accounts** for dev/staging/production

---

## OAuth Scopes Reference

Complete list of scopes requested by the MCP server:

| Scope | API | Purpose |
|-------|-----|---------|
| `https://www.googleapis.com/auth/gmail.modify` | Gmail | Send, read, manage emails |
| `https://www.googleapis.com/auth/drive` | Drive | Full file and folder access |
| `https://www.googleapis.com/auth/spreadsheets` | Sheets | Create and edit spreadsheets |
| `https://www.googleapis.com/auth/documents` | Docs | Create and edit documents |
| `https://www.googleapis.com/auth/calendar` | Calendar | Manage calendar events |
| `https://www.googleapis.com/auth/tasks` | Tasks | Manage task lists |

### Why These Scopes?

- **gmail.modify** (not gmail.readonly): Needed to send emails and manage labels
- **drive** (full): Required for creating folders, moving files, managing permissions
- **spreadsheets**: Create templates, update trackers
- **documents**: Generate documents from templates
- **calendar**: Create events, find time slots
- **tasks**: Create action items from workflows

---

## Advanced Topics

### Service Accounts

For server-to-server authentication (no user interaction):

**Note:** Service accounts have limited Workspace access. Regular OAuth is recommended for most use cases.

### Domain-Wide Delegation

For G Suite administrators accessing multiple user accounts:

**Setup:**
1. Create service account in Google Cloud
2. Enable domain-wide delegation
3. Add scopes in G Suite Admin Console
4. Use service account credentials with user impersonation

**Documentation:** See Google's [Domain-Wide Delegation Guide](https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority)

---

## Support

**Related Documentation:**
- [Installation Guide](installation.md) - Complete setup process
- [Configuration Guide](../reference/configuration.md) - Environment variables
- [Troubleshooting](../reference/troubleshooting.md) - Common issues
- [Security Best Practices](../reference/configuration.md#security)

**External Resources:**
- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google API Scopes](https://developers.google.com/identity/protocols/oauth2/scopes)
- [OAuth 2.0 Best Practices](https://tools.ietf.org/html/rfc6749)

---

**Authentication is a critical security component. Always protect your credentials and tokens!** ðŸ”’
